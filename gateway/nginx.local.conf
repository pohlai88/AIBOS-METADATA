# =================================================================
# AIBOS API Gateway - Local Development Configuration
# =================================================================
# Use this config for local development (localhost instead of Docker service names)

# Upstream servers (local development ports)
upstream bff-admin-config {
    server localhost:3001;
}

upstream bff-payment-cycle {
    server localhost:3002;
}

upstream bff-metadata {
    server localhost:8787;
}

# Main server
server {
    listen 80;
    server_name localhost api.aibos.local;

    # =========================================================
    # Gateway Health & Documentation
    # =========================================================
    
    location = /health {
        return 200 '{"status":"ok","gateway":"nginx","timestamp":"$time_iso8601"}';
        add_header Content-Type application/json;
    }

    location = /docs {
        return 200 '<!DOCTYPE html>
<html>
<head>
    <title>AIBOS API Gateway - Documentation</title>
    <style>
        body { font-family: system-ui, sans-serif; max-width: 900px; margin: 50px auto; padding: 20px; background: #0a0a0a; color: #e5e5e5; }
        h1 { color: #fff; margin-bottom: 0.5rem; }
        h1 + p { color: #888; margin-top: 0; }
        .service { background: #1a1a1a; padding: 24px; margin: 20px 0; border-radius: 12px; border: 1px solid #333; }
        .service h2 { margin-top: 0; color: #fff; }
        .service p { color: #888; margin: 8px 0; }
        a { color: #60a5fa; text-decoration: none; }
        a:hover { text-decoration: underline; }
        code { background: #262626; padding: 2px 8px; border-radius: 4px; color: #22c55e; }
        .status { display: inline-block; width: 8px; height: 8px; background: #22c55e; border-radius: 50%; margin-right: 8px; }
        .links { display: flex; gap: 16px; margin-top: 16px; }
        .links a { padding: 8px 16px; background: #262626; border-radius: 6px; }
    </style>
</head>
<body>
    <h1>ðŸš€ AIBOS API Gateway</h1>
    <p>Central gateway for all BFF services</p>
    
    <div class="service">
        <h2><span class="status"></span>Admin Config BFF</h2>
        <p><strong>Base URL:</strong> <code>/admin-config</code></p>
        <p>User management, authentication, organization settings, audit logs</p>
        <div class="links">
            <a href="/admin-config/docs">ðŸ“– Swagger UI</a>
            <a href="/admin-config/openapi.json">ðŸ“„ OpenAPI</a>
            <a href="/admin-config/health">ðŸ’š Health</a>
        </div>
    </div>
    
    <div class="service">
        <h2><span class="status"></span>Payment Cycle BFF</h2>
        <p><strong>Base URL:</strong> <code>/payment-cycle</code></p>
        <p>Payment requests, approval workflow, disbursement, slip uploads</p>
        <div class="links">
            <a href="/payment-cycle/docs">ðŸ“– Swagger UI</a>
            <a href="/payment-cycle/openapi.json">ðŸ“„ OpenAPI</a>
            <a href="/payment-cycle/health">ðŸ’š Health</a>
        </div>
    </div>
    
    <div class="service">
        <h2><span class="status"></span>Metadata Studio BFF</h2>
        <p><strong>Base URL:</strong> <code>/metadata</code></p>
        <p>Metadata management, definitions, configurations</p>
        <div class="links">
            <a href="/metadata/healthz">ðŸ’š Health</a>
        </div>
    </div>
</body>
</html>';
        add_header Content-Type text/html;
    }

    # =========================================================
    # Admin Config BFF - Port 3001
    # =========================================================
    
    location /admin-config/ {
        rewrite ^/admin-config/(.*) /$1 break;
        
        proxy_pass http://bff-admin-config;
        
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Gateway-Route "admin-config";
    }

    # =========================================================
    # Payment Cycle BFF - Port 3002
    # =========================================================
    
    location /payment-cycle/ {
        rewrite ^/payment-cycle/(.*) /$1 break;
        
        proxy_pass http://bff-payment-cycle;
        
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Gateway-Route "payment-cycle";
    }

    # =========================================================
    # Metadata Studio BFF - Port 8787
    # =========================================================
    
    location /metadata/ {
        rewrite ^/metadata/(.*) /$1 break;
        
        proxy_pass http://bff-metadata;
        
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Gateway-Route "metadata";
    }

    # =========================================================
    # Catch-all for unknown routes
    # =========================================================
    
    location / {
        return 404 '{"error":"Route not found","hint":"Available routes: /admin-config/*, /payment-cycle/*, /metadata/*","docs":"/docs"}';
        add_header Content-Type application/json;
    }
}

