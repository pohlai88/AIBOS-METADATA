# AIBOS API Gateway Configuration
# Path-based routing to BFF services

upstream bff-admin-config {
    server bff-admin-config:3001;
}

upstream bff-payment-cycle {
    server bff-payment-cycle:3002;
}

upstream bff-metadata {
    server metadata-studio:3003;
}

server {
    listen 80;
    server_name api.aibos.local;

    # Health check endpoint
    location /health {
        return 200 '{"status":"ok","gateway":"nginx"}';
        add_header Content-Type application/json;
    }

    # Admin Config BFF
    # External: /admin-config/users/* → Internal: /users/*
    location /admin-config/ {
        rewrite ^/admin-config/(.*) /$1 break;
        proxy_pass http://bff-admin-config;
        
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # Payment Cycle BFF
    # External: /payment-cycle/* → Internal: /*
    location /payment-cycle/ {
        rewrite ^/payment-cycle/(.*) /$1 break;
        proxy_pass http://bff-payment-cycle;
        
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # Metadata Studio BFF
    # External: /metadata/* → Internal: /*
    location /metadata/ {
        rewrite ^/metadata/(.*) /$1 break;
        proxy_pass http://bff-metadata;
        
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # Catch-all for unknown routes
    location / {
        return 404 '{"error":"Route not found","hint":"Use /admin-config/*, /payment-cycle/*, or /metadata/*"}';
        add_header Content-Type application/json;
    }
}

