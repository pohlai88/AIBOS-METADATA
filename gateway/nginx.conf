# =================================================================
# AIBOS API Gateway Configuration
# Path-based routing to BFF services with OpenAPI documentation
# =================================================================

# Upstream servers (BFF services)
upstream bff-admin-config {
    server bff-admin-config:3001;
}

upstream bff-payment-cycle {
    server bff-payment-cycle:3002;
}

upstream bff-metadata {
    server metadata-studio:8787;
}

# Main server
server {
    listen 80;
    server_name api.aibos.local;

    # =========================================================
    # Gateway Health & Documentation
    # =========================================================
    
    # Gateway health check
    location = /health {
        return 200 '{"status":"ok","gateway":"nginx","timestamp":"$time_iso8601"}';
        add_header Content-Type application/json;
    }

    # API documentation index
    location = /docs {
        return 200 '<!DOCTYPE html>
<html>
<head>
    <title>AIBOS API Gateway - Documentation</title>
    <style>
        body { font-family: system-ui, sans-serif; max-width: 800px; margin: 50px auto; padding: 20px; }
        h1 { color: #333; }
        .service { background: #f5f5f5; padding: 20px; margin: 20px 0; border-radius: 8px; }
        .service h2 { margin-top: 0; }
        a { color: #0066cc; }
        code { background: #e5e5e5; padding: 2px 6px; border-radius: 4px; }
    </style>
</head>
<body>
    <h1>ðŸš€ AIBOS API Gateway</h1>
    <p>Central gateway for all BFF services</p>
    
    <div class="service">
        <h2>Admin Config BFF</h2>
        <p><strong>Base URL:</strong> <code>/admin-config</code></p>
        <p>
            <a href="/admin-config/docs">ðŸ“– Swagger UI</a> |
            <a href="/admin-config/openapi.json">ðŸ“„ OpenAPI JSON</a> |
            <a href="/admin-config/health">ðŸ’š Health</a>
        </p>
    </div>
    
    <div class="service">
        <h2>Payment Cycle BFF</h2>
        <p><strong>Base URL:</strong> <code>/payment-cycle</code></p>
        <p>
            <a href="/payment-cycle/docs">ðŸ“– Swagger UI</a> |
            <a href="/payment-cycle/openapi.json">ðŸ“„ OpenAPI JSON</a> |
            <a href="/payment-cycle/health">ðŸ’š Health</a>
        </p>
    </div>
    
    <div class="service">
        <h2>Metadata Studio BFF</h2>
        <p><strong>Base URL:</strong> <code>/metadata</code></p>
        <p>
            <a href="/metadata/healthz">ðŸ’š Health</a>
        </p>
    </div>
</body>
</html>';
        add_header Content-Type text/html;
    }

    # =========================================================
    # Admin Config BFF - Port 3001
    # =========================================================
    # External: /admin-config/* â†’ Internal: /*
    
    location /admin-config/ {
        # Strip /admin-config prefix before proxying
        rewrite ^/admin-config/(.*) /$1 break;
        
        proxy_pass http://bff-admin-config;
        
        # Headers
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Gateway-Route "admin-config";
    }

    # =========================================================
    # Payment Cycle BFF - Port 3002
    # =========================================================
    # External: /payment-cycle/* â†’ Internal: /*
    
    location /payment-cycle/ {
        rewrite ^/payment-cycle/(.*) /$1 break;
        
        proxy_pass http://bff-payment-cycle;
        
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Gateway-Route "payment-cycle";
    }

    # =========================================================
    # Metadata Studio BFF - Port 8787
    # =========================================================
    # External: /metadata/* â†’ Internal: /*
    
    location /metadata/ {
        rewrite ^/metadata/(.*) /$1 break;
        
        proxy_pass http://bff-metadata;
        
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Gateway-Route "metadata";
    }

    # =========================================================
    # Catch-all for unknown routes
    # =========================================================
    
    location / {
        return 404 '{"error":"Route not found","hint":"Available routes: /admin-config/*, /payment-cycle/*, /metadata/*","docs":"/docs"}';
        add_header Content-Type application/json;
    }
}

# =================================================================
# Local Development Server (direct access without prefix stripping)
# =================================================================

server {
    listen 8080;
    server_name localhost;

    # Direct proxy to admin-config (no prefix stripping)
    location / {
        proxy_pass http://bff-admin-config;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }
}
